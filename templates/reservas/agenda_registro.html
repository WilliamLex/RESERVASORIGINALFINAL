{% extends "base.html" %}

{% load widget_tweaks %}

{% block title %}
    Registro | {{ block.super }}
{% endblock %}

{% block container %}
<div class="row">
    <div class="col-md-8 col-md-offset-2">
        <div class="page-header">
            <h1>Programar Reserva Informática</h1>
        </div>
        <form class="form-horizontal" method="post">
            {% csrf_token %}
            {% for error in form.non_field_errors %}
            <div class="alert alert-danger">
                {{ error }}
            </div>
            {% endfor %}
            <fieldset>
                <div class="form-group{% if form.laboratorio.errors %} has-error{% endif %}">
                  <label for="{{ form.laboratorio.auto_id }}" class="col-md-3 control-label">
                  {{ form.laboratorio.label }}</label>
                  <div class="col-md-9">
                    <select name="laboratorio" id="laboratorio" class="form-control">
                        {% for lab in laboratorios_disponibles %}
                            <option value="{{ lab.id }}">{{ lab.nombre }}</option>
                        {% endfor %}
                    </select>

                    {% for error in form.laboratorio.errors %}
                    <span class="help-block">{{ error }}</span>
                    {% endfor %}
                  </div>
                </div>
                <div class="form-group{% if form.dia.errors %} has-error{% endif %}">
                  <label for="{{ form.dia.auto_ud }}" class="col-md-3 control-label">
                  {{ form.dia.label }}</label>
                  <div class="col-md-9">
                    {% render_field form.dia type="date" class="form-control" id="fecha" placeholder="12/08/2023" %}
                    {% for error in form.dia.errors %}
                    <span class="help-block">{{ error }}</span>
                    {% endfor %}
                  </div>
                </div>
                <div class="form-group{% if form.horario.errors %} has-error{% endif %}">
                  <label for="{{ form.horario.auto_id }}" class="col-md-3 control-label">
                  {{ form.horario.label }}</label>
                  <div class="col-md-9">
                    {% render_field form.horario class="form-control" %}

                    {% for error in form.horario.errors %}
                    <span class="help-block">{{ error }}</span>
                    {% endfor %}
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-md-9 col-md-offset-3">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                  </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

// Función para establecer una cookie, que será necesario para las solicitudes Ajax con Django
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

 $(document).ready(function() {
    // Selecciona el elemento de fecha por su ID
    var fechaElemento = $("#fecha");

    // Agrega un controlador de eventos onchange
    fechaElemento.on("change", function() {
      // El código que deseas ejecutar cuando cambie la fecha va aquí
      var nuevaFecha = fechaElemento.val();
      
      // Obtiene una cookie csrftoken
      var csrftoken = getCookie('csrftoken');
      console.log("laboratorio: "+ $("#laboratorio").val())
      console.log("Fecha seleccionada:", nuevaFecha);

      $.ajax({
          url: '/consultar-disponibilidad/',
          type: 'POST',
          data: {
              "laboratorio": $("#laboratorio").val(),
              "fecha": nuevaFecha,
              csrfmiddlewaretoken: csrftoken
          },
          dataType: 'json'
      }).done(function (data) {
         // Respuesta exitosa

         // Rellener select de horarios con la informacion que proveien en la variable "data"



      }).fail(function (jqXHR, textStatus, errorThrown) {
        // Respuesta de error en el servidor
      }).always(function (data) {
        // Respuesta de error en frontend
      });


    });
  });
</script>
{% endblock %}
